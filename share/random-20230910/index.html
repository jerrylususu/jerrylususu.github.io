<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="generator" content="Hugo 0.82.0" />
		<title>随机分享（230910）：Typescript 中 Any 关闭类型检查 &amp; Linux 中的内存占用 - Nekonull&#39;s Garden</title>

		<meta name="description" content="（没有干货，全是湿货&hellip;不过至少写一些总比完全没有写强？） 本周遇到的 Bug 遇到了两个前端相关的 bug，排查了很久，不过最后发现都是人">


		
	
		




<link rel="stylesheet" href="/css/ui.css">

	
		

		<script defer src="/js/dark-mode.js"></script>
		<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css">

		<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3973436778637330"
		crossorigin="anonymous"></script>

		<link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">

		
				
		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R01JLDY2KE"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-R01JLDY2KE', { 'anonymize_ip': false });
}
</script>

	</head>

<body>
<header class="container no-print">
	<div class="u-header">
		<nav class="bar">
	<ul><li>
			<a href="/">
				<img class="icon-text" src="/img/prev.svg"/>
			</a>
		</li><li><img class="icon-text" id="dark-mode-toggle" src="/img/moon-regular.svg" alt="Toggle Dark Mode"></a></li><li><a href="/about">About</a></li><li><a href="/archive">Archive</a></li><li><a href="/posts">Posts</a></li><li><a href="/project">Project</a></li><li><a href="/share">Share</a></li><li><a href="/tags">Tag</a></li></ul>
</nav>

	</div>
</header>
<main class="container">

<article>
	<header><hgroup id="brand">
	<h1>随机分享（230910）：Typescript 中 Any 关闭类型检查 &amp; Linux 中的内存占用</h1>
	<h5>
		
		<time datetime="2023-09-10 16:05:00 &#43;0800 &#43;0800">Sep 10, 2023</time>
		<span class="no-print">
			-
				
				<a href="/tags/random">random</a>
				
				<a href="/tags/typescript">typescript</a>
				
				<a href="/tags/frontend">frontend</a>
				<span>
	</h5>
	
</hgroup>
<hr class="sep" />
</header>
	<p>（没有干货，全是湿货&hellip;不过至少写一些总比完全没有写强？）</p>
<h2 id="本周遇到的-bug">本周遇到的 Bug</h2>
<p>遇到了两个前端相关的 bug，排查了很久，不过最后发现都是人的问题而非代码的问题&hellip;</p>
<ol>
<li>CI 坏了还能跑？
<ul>
<li>现象：某前端项目，其他人参加开发的时候发现 master 分支无法 <code>npm install</code>，但之前这个 repo 一直在正常更新版本，看 CI 日志也一切正常</li>
<li>原因：发现问题是上游某依赖方对已发布的包重新发布，导致文件 hash 变化，<code>npm install</code> 时实际文件 hash 和 lock 中 hash 不一致，所以失败；CI 之所以能跑是因为流水线里加了一层 cache，只要 <code>packages-lock.json</code> 不变就会复用之前的 cache，而恰巧上游重发包之后这个文件一直没变过，所以每次跑 CI 都是拉的已有的 cache，没有实际在流水线里执行 <code>npm install</code>，未能即使暴露故障</li>
<li>解决：重建 <code>packages-lock.json</code>，让 CI 中的 cache 无效</li>
</ul>
</li>
<li>本地坏了，线上是好的？
<ul>
<li>现象：某前端项目，例行更新依赖库版本，发布前自测发现某功能测试环境不可用；但相同功能在线上一切正常</li>
<li>原因：拉线上版本回本地排查，发现线上的版本和实际代码的主干版本不一致(!)；查阅发布记录，发现线上版本最近发布已经是一年多之前。和开发了解，原来现在的这个前端项目是原来的两个前端项目合并而来的，部署的时候其实要部署两次，但合并后的部署只部署了另一个模块，而没有部署当前模块，所以现在线上跑的实际上还是合并前的版本。</li>
<li>解决：修复代码问题，本地验证通过后发布线上；补充 readme 说明发布时需要两个模块都发布</li>
</ul>
</li>
</ol>
<h2 id="typescript-中-any-关闭了类型检查">Typescript 中 Any 关闭了类型检查</h2>
<p>某后端项目，因为历史原因代码中有较多 any。最近发现代码中某处接受用户输入的位置有问题，默认值的类型不正确但依然通过了编译。示例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// 不要这样用！
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">names</span>: <span style="color:#66d9ef">string</span>[] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>).<span style="color:#a6e22e">names</span> <span style="color:#f92672">??</span> <span style="color:#e6db74">&#39;&#39;</span>;
<span style="color:#75715e">//    ^string[]                           ^any     ^string
</span></code></pre></div><p>注意到这里 nullish coalescing （<code>??</code>）的默认值是个 <code>string</code> 而非 string[]。这段代码感觉上上不应该通过编译，但是因为 <code>(req.body as any)</code> 的 <code>any</code> 类型禁用了类型检查，因此编译时不会再检查缺省值，实际上可以编译通过。而如果不巧后续有函数需要使用 <code>string[]</code> 才有的方法，而 <code>req.body</code> 中的 <code>names</code> 的确为 undefined，就会导致问题。</p>
<p>要解决这个问题，需要提供了更强的类型提示，让 Typescript 的检查可以正常执行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// 直接标记可能的类型：string[] 或 undefined
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">names</span>: <span style="color:#66d9ef">string</span>[] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>).<span style="color:#a6e22e">names</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">string</span>[] <span style="color:#f92672">|</span> <span style="color:#66d9ef">undefined</span> <span style="color:#f92672">??</span> <span style="color:#e6db74">&#39;&#39;</span>;

<span style="color:#75715e">// 通过一个自定义 type 来实现
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Nullable</span>&lt;<span style="color:#f92672">T</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">T</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">undefined</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">names</span>: <span style="color:#66d9ef">string</span>[] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>).<span style="color:#a6e22e">names</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">Nullable</span>&lt;<span style="color:#f92672">string</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; <span style="color:#f92672">??</span> <span style="color:#e6db74">&#39;&#39;</span>;
</code></pre></div><p><a href="https://www.typescriptlang.org/play?#code/MYewdgzgLgBATgUwI4wLwwN4CgYwEYgAmAngFyYC+WFA3FlgPQMxggygC2ADgJYA2CGAjhwQcRs1CRYYAIYcEEctDg8wAcwDaAXTQwAFIiQA6AiRiyIFsMQCUxuQqsB+ZzADk7uk3bgIIAWM+EHV9R0VjACsQNX13ABp3W1s6CQtCQhgOMUFCBAAzNQQoHnAsKWgWeUVlKFUNHT1DZFMiYgsrWRt7cM6rFTUtXQAfGABXMDzCsARM1w8veh8xGEixyuBEWShBLpAoAAthGChiLgQsU-OYADkxvj5ZPAEAHgAVAD49N5hRiamiplRmB7nw6BUZNUIAAmWr1IZNIytcyWax2BxQjq3UFPV4DBraL7zTx0IA">Typescript Playground</a></p>
<h2 id="linux-中的内存占用">Linux 中的内存占用</h2>
<p>Linux 进程内存不同计算方法的区分：VSS, RSS, PSS, USS</p>
<pre><code>
  ┌────────┐
  │        │
  │        │        ┌────────┐
  │ Unused │        │        │
  │  (A)   │        │ ...    │◄───┐
  │        │        │        │    │Other
  │        │        ├────────┤    │Program's
  │        │        │        │    │Share
  ├────────┤        │ ...    │◄───┘ (D)
  │        │        │        │
  │ Used   │        ├────────┤
  │  (B)   │        │        │
  │        │        │My Share│
  │        │        │   (C)  │
  └────────┘        └────────┘

   Exclusive         Shared

</code></pre><p>可以把进程的内存占用视作上图。首先程序有自己独占的虚拟内存空间（Exclusive），其中可以分为已经使用了的（B）和属于自己但还未使用的（A）。其次进程还会使用一些共享内存（Shared），例如 so 动态运行库和 mmap 映射。考虑到这些共享内存多个进程都会用到，将其完全计算在某个特定进程名下听起来就不太合理，因此这里可以考虑类似于现实中的&quot;公摊面积&quot;，根据实际使用的进程数把这部分内存占用平摊成 N 份，当前进程只计算其中一份（C），剩余的计算在其他进程下（D）。</p>
<p>由此我们可以得到四种不同的计算方法，见下表</p>
<table>
<thead>
<tr>
<th>指标</th>
<th>含义</th>
<th>组成</th>
<th>说明</th>
<th>图例</th>
</tr>
</thead>
<tbody>
<tr>
<td>VSS</td>
<td>虚拟内存集合（Virtual Set Size）</td>
<td>所有进程地址空间中的所有内存</td>
<td>进程可以访问的虚拟内存空间大小</td>
<td>A+B+C+D</td>
</tr>
<tr>
<td>RSS</td>
<td>常驻内存集合（Resident Set Size）</td>
<td>进程当前实际使用的物理内存</td>
<td>实际分配的内存，不需要缺页中断就可以使用</td>
<td>B+C+D</td>
</tr>
<tr>
<td>PSS</td>
<td>共享内存集合（Proportional Set Size）</td>
<td>进程当前实际使用的物理内存，按比例分配共享内存</td>
<td>按比例分配共享内存，适用于多个进程共享同一块内存的情况</td>
<td>B+C</td>
</tr>
<tr>
<td>USS</td>
<td>独立内存集合（Unique Set Size）</td>
<td>进程独占使用的物理内存</td>
<td>只包含进程独占使用的物理内存，不包括共享库和映射的文件</td>
<td>B</td>
</tr>
</tbody>
</table>
<p>Via：<a href="https://www.bilibili.com/video/BV11z4y1L7Xx">B站视频：用什么指标来衡量我的程序占用了多少内存</a></p>
<h2 id="其他">其他</h2>
<p>最后顺带一提，本博客目前把 RSS 改为了全文输出模式（参考<a href="https://www.godo.dev/tutorials/hugo-full-text-rss/">这篇文章</a>，<a href="https://github.com/jerrylususu/jerrylususu.github.io/commit/89e1c23d0b350baac0378ad735127cf17fb66c4b">实际 commit</a>），希望可以帮到在 RSS 阅读器中阅读本博客的读者。</p>

</article>
<nav class="no-print post-nav">

	<a class="prev-post" href="/share/lofi-bat/">
		<img class="icon-text" src="/img/prev.svg"/>播放 Lofi Girl 的小脚本</a>


	<a class="next-post" href="/share/migrate-to-giscus/">评论系统从 Disqus 迁移到 Giscus<img class="icon-text" src="/img/next.svg"/>
	</a>

</nav>


<section id="related">
  <h4>另请参阅</h4>
  <ul>
    
  	<li><a href="/posts/back-again-2023/">再次复活（2023）&amp; 换用 Github Action 部署</a></li>
  	
  	<li><a href="/share/lofi-bat/">播放 Lofi Girl 的小脚本</a></li>
  	
  	<li><a href="/share/console-save/">在 devtool 控制台里爬网站</a></li>
  	
  </ul>
</section>




	
  <script
    src="https://giscus.app/client.js"
    data-repo="jerrylususu/jerrylususu.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxNDM1MTk3NDY="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOCI3wAs4CZNcG"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-input-position="top"
    data-theme="preferred-color-scheme"
    data-lang="zh-CN"
    data-loading="lazy"
    data-strict="1"
    
    data-theme="preferred-color-scheme"
    crossorigin="anonymous"
    async
  ></script>

			<hr class="sep" />
		</main>
		<footer class="container no-print">
			<div class="u-footer">
				

<a href="https://github.com/jerrylususu/"><img class="icon-social" src="/img/github.svg" alt="Github"/></a>



<a href="/index.xml" target="_blank"><img class="icon-social" src="/img/feed.svg" alt="Feed"></a>


				<p>
					
					使用的主题: <a href="https://github.com/yursan9/manis-hugo-theme">Manis</a><br>
					
					
					
				</p>
				
				<a href="#brand">
					<img class="icon-text" src="/img/toup.svg" alt="To Up"/>
					<span>回到顶部</span>
				</a>
				
			</div>
		</footer>
		
	</body>
</html>

